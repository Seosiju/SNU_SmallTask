# 실습 9: 카페 Kiosk 자연어 인터페이스 (RAG)

## 📋 개요

이 실습은 RAG(Retrieval-Augmented Generation) 기술을 활용하여 카페 키오스크용 자연어 인터페이스를 구현하는 프로젝트입니다. 프론트엔드 없이 질의 리스트를 입력하면 결과 리포트를 생성하는 시스템을 구축합니다.

**사용법:** 환경설치(필요시) → 데이터 생성 → 인덱스 구축 → 로직 로딩 → 배치 리포트 실행

## 🎯 주요 기능

- **메뉴 데이터 관리**: 11종 음료, 8종 디저트, 9종 옵션을 JSON 형태로 관리
- **벡터 검색**: multilingual-e5-base 모델을 사용한 의미 기반 검색 (768차원)
- **인텐트 분류**: 정규식 기반 의도 분류 (order, option, recommend, complex, menu_info, cart_summary)
- **장바구니 관리**: 주문 항목 추가, 옵션 적용, 가격 계산, 수량 관리
- **LLM 통합**: OpenAI GPT-4o-mini API를 활용한 자연스러운 응답 생성
- **오프라인 Fallback**: LLM 없이도 동작하는 규칙 기반 응답 시스템
- **대화형 인터페이스**: 실시간 채팅 형태의 키오스크 시연 (대화 히스토리 관리)

## 🛠️ 기술 스택

- **임베딩 모델**: `intfloat/multilingual-e5-base`
- **벡터 데이터베이스**: FAISS
- **LLM**: OpenAI GPT-4o-mini
- **프레임워크**: LangChain, Sentence Transformers
- **데이터 처리**: Pandas, JSON

## 📁 파일 구조

```
task(9)/
├── task(9).ipynb          # 메인 실습 노트북
├── task(9)_presentation.pdf  # 발표 자료
├── menu.json              # 메뉴 데이터 (음료, 디저트, 옵션)
├── menu.faiss             # FAISS 벡터 인덱스
├── menu_store.json        # 메타데이터 및 청크 저장소
└── README_task(9).md      # 이 파일
```

## 🚀 실행 방법

### 1. 환경 설정

```bash
pip install sentence-transformers faiss-cpu langchain langchain-openai python-dotenv
```

### 2. 실행 순서

1. **환경 설치**: 필요한 라이브러리 설치
2. **데이터 생성**: 메뉴 데이터를 JSON 파일로 생성 (29개 청크)
3. **인덱스 구축**: 벡터 임베딩 및 FAISS 인덱스 생성 (768차원)
4. **로직 로딩**: 챗봇 핵심 로직 구현 (인텐트 분류 + RAG + 응답 생성)
5. **API 연결 확인**: OpenAI API 연결 상태 테스트
6. **배치 리포트**: 질의 리스트 자동 처리 (9개 테스트 케이스)
7. **시연**: 대화형 인터페이스 테스트 (실시간 채팅)

## 📊 메뉴 데이터 구조

### 음료 (Drinks) - 11종

- **커피**: 아메리카노, 카페 라떼, 바닐라 라떼, 카푸치노, 콜드 브루, 돌체 라떼, 에스프레소
- **논커피**: 녹차 라떼, 초콜릿 라떼, 딸기 스무디, 망고 스무디
- **사이즈**: S(3500-4300원), M(4000-5500원), L(4500-6000원)
- **정보**: 가격, 설명, 페어링, 태그(진함 정도, 달콤함 등)

### 디저트 (Desserts) - 8종

- **크루아상**: 플레인(3000원), 초콜릿(3500원), 아몬드(3500원)
- **기타**: 마들렌(2500원), 초콜릿 칩 쿠키(2800원), 마카롱(3000원)
- **케이크**: 치즈 케이크(6000원), 티라미수(6000원)

### 옵션 (Options) - 9종

- **샷**: 샷 추가(+500원, 커피 전용)
- **시럽**: 바닐라/캐러멜/헤이즐넛(+300원, 모든 메뉴)
- **우유**: 저지방(0원), 두유(+500원), 아몬드 브리즈(+700원, 라떼 계열)
- **기타**: 휘핑 크림(+500원, 초콜릿 계열), 테이크아웃 할인(-500원, 모든 메뉴)

## 🔍 인텐트 분류

| 인텐트           | 패턴                                                                                              | 설명                    |
| ---------------- | ------------------------------------------------------------------------------------------------- | ----------------------- |
| `order`        | "주세요", "주문", "살게요", "계산"                                                                | 메뉴 주문               |
| `option`       | "추가", "뺄", "변경", "우유", "샷", "시럽", "휘핑", "테이크아웃", "사이즈 업", "업사이즈", "옵션" | 옵션 관련               |
| `recommend`    | "추천", "달콤", "상큼", "시원", "인기", "베스트", "입문"                                          | 추천 요청               |
| `complex`      | "그리고", "둘 다", "함께", "같이", "비교", "중에 뭐가", "더", "가격은 어떻게"                     | 복합 질의               |
| `menu_info`    | "가격", "얼마", "설명", "성분", "사이즈", "크기", "카페인", "진해", "연해", "진함", "산미"        | 메뉴 정보               |
| `cart_summary` | "장바구니"                                                                                        | 장바구니 조회           |
| `other`        | 기타 모든 질문                                                                                    | 카페 업무와 무관한 질문 |

## 💡 핵심 구현 사항

### 1. 벡터 검색 시스템

```python
def retrieve(q, topk=4):
    qv = emb_model.encode([q], normalize_embeddings=True, convert_to_numpy=True)
    D, I = index.search(qv, topk)
    return [{"text": store["chunks"][i], "meta": store["meta"][i], "score": float(D[0][j])} for j, i in enumerate(I[0])]
```

### 2. 인텐트 분류 시스템

```python
INTENT_PATTERNS = {
    "order": r"(주세요|주문|살게요|계산)",
    "option": r"(추가|뺄|변경|우유|샷|시럽|휘핑|테이크아웃|사이즈 업|업사이즈|옵션)",
    "recommend": r"(추천|달콤|상큼|시원|인기|베스트|입문)",
    "complex": r"(그리고|둘 다|함께|같이|비교|중에 뭐가|더|가격은 어떻게)",
    "menu_info": r"(가격|얼마|설명|성분|사이즈|크기|카페인|진해|연해|진함|산미)",
    "other": r".*"
}
```

### 3. 장바구니 관리

```python
@dataclass
class CartItem:
    item_id: str
    name: str
    kind: str
    size: str | None
    base_price: int
    qty: int = 1
    options: List[Dict] = field(default_factory=list)
  
    def total_price(self):
        return (self.base_price + sum(o["price"] for o in self.options)) * self.qty
```

### 4. LLM 통합 응답 생성

- **OpenAI API**: GPT-4o-mini 모델 사용
- **의도별 프롬프트**: 각 인텐트별 맞춤형 프롬프트 템플릿
- **오프라인 Fallback**: LLM 실패 시 규칙 기반 응답 시스템
- **API 연결 확인**: 실시간 API 상태 모니터링

### 5. 대화 히스토리 관리

- **최근 턴 관리**: 최대 12턴 유지 (유저-어시스턴트 쌍)
- **대화 요약**: 길이 관리용 자동 요약
- **자연스러운 응답**: 사실 데이터 기반 LLM 응답 생성

## 🧪 테스트 케이스

### 배치 테스트 (9개 케이스)

1. **메뉴 정보**: "아메리카노 M 사이즈 가격이 얼마야?"
2. **추천 요청**: "달콤한 음료 추천해줘."
3. **주문 처리**: "카페 라떼 하나 주문할게요."
4. **옵션 문의**: "두유로 바꿔도 돼?"
5. **복합 질의**: "아메리카노랑 카푸치노 중에 뭐가 더 진해요? 그리고 가격은 어떻게 되나요?"
6. **디저트 정보**: "치즈 케이크 가격은?"
7. **옵션 목록**: "옵션 뭐 있어?"
8. **무관 질문**: "오늘 날씨 어때?"
9. **장바구니 조회**: "장바구니 보여줘."

### HTI 테스트 (6개 케이스)

- **TS-001**: 메뉴 탐색/정보 - "아메리카노 가격?"
- **TS-002**: 추천(취향) - "달콤한 음료 추천"
- **TS-003**: 옵션 - "라떼 두유로 변경 가능해?"
- **TS-004**: 복합 - "아메리카노 vs 카푸치노 뭐가 진해? 가격은?"
- **TS-005**: 주문/장바구니 - "바닐라 라떼 하나 주세요"
- **TS-006**: 무관 질의 - "오늘 날씨 어때?"

### 대화형 테스트

- **실시간 채팅**: 자연스러운 대화 인터페이스
- **대화 히스토리**: 최대 12턴 유지 및 자동 요약
- **자연스러운 응답**: 사실 데이터 기반 LLM 응답 생성
- **이모지 활용**: 친근한 카페 직원 톤

## 📈 성능 특징

- **빠른 검색**: FAISS IndexFlatIP를 통한 고속 벡터 검색 (768차원)
- **정확한 분류**: 정규식 기반 인텐트 분류 (7개 카테고리)
- **유연한 응답**: LLM + 규칙 기반 하이브리드 시스템
- **다국어 지원**: multilingual-e5-base 모델 활용
- **오프라인 동작**: LLM 없이도 기본 기능 제공
- **실시간 대화**: 대화 히스토리 관리 및 자연스러운 응답
- **확장 가능**: 새로운 메뉴/옵션 쉽게 추가 가능

## 🔧 설정 및 커스터마이징

### 환경 변수

```bash
OPENAI_API_KEY=your_api_key_here
```

### 메뉴 데이터 수정

`menu.json` 파일을 수정하여 메뉴 정보를 업데이트할 수 있습니다.

### 인텐트 패턴 수정

`INTENT_PATTERNS` 딕셔너리를 수정하여 새로운 의도 패턴을 추가할 수 있습니다.

## 📝 사용 예시

### 기본 사용법

```python
# 장바구니 생성 및 주문
cart = OrderManager(menu)
intent, response = answer("아메리카노 M 사이즈 주문해주세요", cart)
print(response)

# 장바구니 확인
print(cart.summary())
```

### 대화형 인터페이스

```python
# 실시간 채팅 시작
print(":커피:️ 자연스러운 LLM 대화형 카페 키오스크 :커피:️")
while True:
    user_input = input("User: ").strip()
    if user_input.lower() in ["quit", "exit"]:
        break
    intent, response = answer(user_input, cart, show_ctx=False)
    print(f"Kiosk: {response}")
```

### API 연결 확인

```python
# OpenAI API 연결 상태 확인
api_status = check_api_connection()
print(f"LLM 사용 가능 여부: {llm is not None}")
print(f"API 연결 상태: {api_status}")
```

## 🎯 학습 목표

1. **RAG 시스템 구현**: 검색과 생성의 결합으로 정확한 정보 제공
2. **인텐트 분류**: 정규식 기반 자연어 의도 파악
3. **벡터 검색**: multilingual-e5-base를 활용한 의미 기반 정보 검색
4. **대화 시스템**: 장바구니 상태 관리와 대화 맥락 유지
5. **하이브리드 AI**: LLM + 규칙 기반 시스템의 장점 결합
6. **실용적 AI**: 실제 카페 키오스크에 적용 가능한 완성도 높은 시스템
7. **API 통합**: OpenAI API를 활용한 자연스러운 응답 생성
8. **오프라인 대응**: LLM 없이도 동작하는 견고한 시스템 설계

## 🔄 시스템 아키텍처

```
사용자 질문 → 인텐트 분류 → 벡터 검색 → LLM 응답 생성 → 장바구니 업데이트
     ↓              ↓           ↓            ↓              ↓
  정규식 패턴    FAISS 검색   프롬프트 템플릿   자연어 응답    상태 관리
     ↓              ↓           ↓            ↓              ↓
  의도 파악    관련 문서 검색   컨텍스트 결합   오프라인 Fallback  가격 계산
```
